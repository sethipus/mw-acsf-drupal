<?php

/**
 * @file
 * MARS Product module main file.
 */

use Acquia\Blt\Robo\Common\EnvironmentDetector;
use Drupal\Component\Serialization\Json;
use Drupal\Core\Asset\AttachedAssetsInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\field\FieldConfigInterface;
use Drupal\mars_product\Plugin\Block\PdpHeroBlock;
use Drupal\Core\Form\FormStateInterface;
use Drupal\mars_common\Form\MarsCardColorSettingsForm;
use Drupal\Core\Config\ImmutableConfig;
use Drupal\mars_product\Form\BazaarvoiceConfigForm;

/**
 * Implements hook_theme().
 */
function mars_product_theme($existing, $type, $theme, $path) {
  return [
    'pdp_hero_block' => [
      'variables' => [
        'pdp_common_data' => [],
        'pdp_size_data' => [],
        'pdp_data' => [],
        'pdp_bundle_type' => [],
      ],
      'template' => 'pdp-hero-block',
    ],
    'product_content_pair_up_block' => [
      'variables' => [
        'title' => NULL,
        'graphic_divider' => NULL,
        'background' => NULL,
        'lead_card_entity' => NULL,
        'lead_card_eyebrow' => NULL,
        'lead_card_title' => NULL,
        'cta_link_url' => NULL,
        'cta_link_text' => NULL,
        'supporting_card_entity' => NULL,
        'supporting_card_entity_view' => NULL,
        'dark_overlay' => NULL,
      ],
      'template' => 'product-content-pair-up-block',
    ],
    'pdp_rating_block' => [
      'variables' => [
        'items' => [],
      ],
      'template' => 'pdp-rating-block',
    ],
  ];
}

/**
 * Implements hook_page_attachments().
 */
function mars_product_page_attachments(&$page) {
  $wtb_config = \Drupal::config('mars_product.wtb.settings');
  $vendor = $wtb_config->get('commerce_vendor') ?? '';
  $commerce_vendor_settings = [];
  if (!empty($vendor)) {
    $commerce_vendor_settings = \Drupal::configFactory()->get('mars_product.wtb.' . $vendor . '.settings');
    $commerce_vendor_settings = !$commerce_vendor_settings->isNew() ? $commerce_vendor_settings->getRawData()['settings'] : [];
  }
  $metatags = [];
  $current_uri = \Drupal::request()->getRequestUri();
  switch ($vendor) {

    case PdpHeroBlock::VENDOR_PRICE_SPIDER:
      $page['#attached']['library'][] = 'mars_product/price_spider';
      $metatags = [
        'ps-account' => [
          '#tag' => 'meta',
          '#attributes' => [
            'name' => 'ps-account',
            'content' => !empty($commerce_vendor_settings['account_id']) ? $commerce_vendor_settings['account_id'] : '',
          ],
        ],
        'ps-country' => [
          '#tag' => 'meta',
          '#attributes' => [
            'name' => 'ps-country',
            'content' => \Drupal::configFactory()
              ->get('system.date')
              ->get('country.default'),
          ],
        ],
        'ps-language' => [
          '#tag' => 'meta',
          '#attributes' => [
            'name' => 'ps-language',
            'content' => strtolower(\Drupal::languageManager()
              ->getCurrentLanguage()
              ->getId()),
          ],
        ],
      ];
      break;

    case PdpHeroBlock::VENDOR_SMART_COMMERCE:
      $page['#attached']['library'][] = 'mars_product/smart_commerce';
      $metatags = [
        'smart_commerce_brand_js' => [
          '#tag' => 'script',
          '#attributes' => [
            'id' => 'smart-commerce-brand-js',
            'type' => 'text/javascript',
            'src' => ($current_uri == '/where-buy' || count(explode("/", $current_uri)) >= 1) ? $commerce_vendor_settings['brand_js'] : '\/',
            'data-src' => !empty($commerce_vendor_settings['brand_js']) ? $commerce_vendor_settings['brand_js'] : '',
          ],
        ],
        'smart_commerce_brand_css' => [
          '#tag' => 'style',
          '#attributes' => [
            'id' => 'smart-commerce-brand-css',
            'src' => ($current_uri == '/where-buy' || count(explode("/", $current_uri)) >= 1) ? $commerce_vendor_settings['brand_css'] : '\/',
            'data-src' => !empty($commerce_vendor_settings['brand_css']) ? $commerce_vendor_settings['brand_css'] : '',
          ],
        ],
      ];
      break;

    case PdpHeroBlock::VENDOR_COMMERCE_CONNECTOR:
      $page['#attached']['library'][] = 'mars_product/mars_product.commerce_connector';
      break;

    default:
      break;
  }

  foreach ($metatags as $key => $metatag) {
    $page['#attached']['html_head'][] = [$metatag, $key];
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function mars_common_preprocess_node__product__card(array &$variables) {
  product_card_add_variant_vars($variables);
  product_card_add_bazaarvoice_vars($variables);
  product_card_add_wtb_vars($variables);
  product_card_add_datalayer_vars($variables);
  product_card_add_labels($variables);
  product_card_change_color($variables);
}

/**
 * Implements hook_preprocess_HOOK().
 */
function mars_common_preprocess_node__product_multipack__card(array &$variables) {
  product_card_add_variant_vars($variables);
  product_card_add_bazaarvoice_vars($variables);
  product_card_add_wtb_vars($variables);
  product_card_add_datalayer_vars($variables);
  product_card_add_labels($variables);
  product_card_change_color($variables);
}

/**
 * Add Where to buy related vars.
 *
 * @param array $variables
 *   Variables.
 */
function product_card_add_wtb_vars(array &$variables) {
  $wtb_config = \Drupal::config('mars_product.wtb.settings');
  $product_helper = \Drupal::service('mars_product.product_helper');
  $vendor = $wtb_config->get('commerce_vendor') ?? '';

  $display = 'product_card';
  $widget_id_field = $product_helper->getWidgetIdField($display);
  // Display WTB button once Commerce Vendor selected.
  if (!empty($vendor) && $vendor !== PdpHeroBlock::VENDOR_NONE) {
    $commerce_vendor_settings = \Drupal::configFactory()->get('mars_product.wtb.' . $vendor . '.settings');
    $commerce_vendor_settings = !$commerce_vendor_settings->isNew() ? $commerce_vendor_settings->getRawData()['settings'] : [];
    $variables['wtb_commerce_vendor'] = $vendor;
    $variables['wtb_button_type'] = !empty($commerce_vendor_settings['button_type']) ? $commerce_vendor_settings['button_type'] : NULL;
    $variables['wtb_account_id'] = !empty($commerce_vendor_settings['account_id']) ? $commerce_vendor_settings['account_id'] : NULL;
    $variables['wtb_widget_id'] = !empty($commerce_vendor_settings[$widget_id_field]) ? $commerce_vendor_settings[$widget_id_field] : NULL;
    $variables['wtb_cta_title'] = !empty($commerce_vendor_settings['cta_title']) ? $commerce_vendor_settings['cta_title'] : NULL;
    $variables['wtb_display'] = $display;

    $button_class = (
        $vendor == PdpHeroBlock::VENDOR_COMMERCE_CONNECTOR &&
        $commerce_vendor_settings['add_class']
      )
      ? $commerce_vendor_settings['button_class']
      : NULL;

    $variables['wtb_button_class'] = $button_class;

    $variant = $variables['main_variant'] ?? NULL;
    if (isset($variant) &&
      $vendor == PdpHeroBlock::VENDOR_MANUAL_LINK_SELECTION &&
      !$variant->get('field_product_hide_wtb_link')->value) {

      $variables['wtb_manual_link_info'] = [
        'button_name' => $variant->get('field_product_wtb_button_name')->value ?? $commerce_vendor_settings['button_name'],
        'button_url' => $variant->get('field_product_wtb_button_url')->value ?? $commerce_vendor_settings['button_url'],
        'button_new_tab' => $variant->get('field_product_wtb_new_tab')->value ?? $commerce_vendor_settings['button_new_tab'],
        'button_style' => $variant->get('field_product_wtb_button_style')->value ?? $commerce_vendor_settings['button_style'],
      ];
    }
  }
}

/**
 * Add Where to buy related vars.
 *
 * @param array $variables
 *   Variables.
 */
function product_card_add_bazaarvoice_vars(array &$variables) {
  $show_rating_and_reviews = NULL;
  $product = $variables['node'];

  if ($product->hasField('field_rating_and_reviews') &&
    $product->hasField('field_override_global_rating') &&
    $product->get('field_override_global_rating')->value == TRUE
  ) {
    $show_rating_and_reviews = $product->get('field_rating_and_reviews')->value;
  }
  else {
    $show_rating_and_reviews = \Drupal::config(BazaarvoiceConfigForm::SETTINGS)
      ->get('show_rating_and_reviews');
  }

  if ($show_rating_and_reviews) {
    $variables['#attached']['library'][] = 'mars_product/mars_product.bazaarvoice';
  }
  $variables['show_rating_and_reviews'] = $show_rating_and_reviews;
}

/**
 * Add Where to buy related vars.
 *
 * @param array $variables
 *   Variables.
 */
function product_card_add_variant_vars(array &$variables) {
  /** @var \Drupal\mars_product\ProductHelper $product_helper */
  $product_helper = \Drupal::service('mars_product.product_helper');
  /** @var \Drupal\node\Entity\Node|null $product */
  $product = $variables['node'] ?? NULL;

  if ($product) {
    $main_variant = $product_helper->mainVariant($product);
    $variables['main_variant'] = $main_variant;

    if ($main_variant && $main_variant->hasField('field_product_sku')) {
      $sku = $main_variant->get('field_product_sku')->value ?? '';
      $variables['product_sku'] = $product_helper->formatSku(trim($sku));
    }
  }
}

/**
 * Add datalayer related vars.
 *
 * @param array $variables
 *   Variables.
 */
function product_card_add_datalayer_vars(array &$variables) {

  $node = $variables['node'];
  $terms = [];
  $field_defs = $node->getFieldDefinitions();
  foreach ($field_defs as $field_name => $field_def) {
    if ($field_def instanceof FieldConfigInterface &&
      $field_def->getType() == 'entity_reference' &&
      $field_def->getSetting('target_type') == 'taxonomy_term'
    ) {

      $term_entites = $node->get($field_name)->referencedEntities();
      foreach ($term_entites as $term_entity) {
        /* @var \Drupal\taxonomy\Entity\Term $term_entity */
        $terms[$term_entity->referencedEntities()[0]->label()][$term_entity->label()] = $term_entity->label();
      }
    }
  }

  $ga_taxonomy_data = NULL;
  if (!empty($terms)) {
    foreach ($terms as $vid => $term_labels) {
      $ga_taxonomy_data[$vid] = array_values($term_labels);
    }
  }
  $variables['datalayer_taxonomy'] = Json::encode($ga_taxonomy_data);
}

/**
 * Add the configured labels to cards.
 *
 * @param array $variables
 *   Variables.
 */
function product_card_add_labels(array &$variables) {
  card_add_badge_text($variables);
  card_add_button_label($variables, 'product_card_button');
  add_cache_by_label_config($variables);
}

/**
 * Implements hook_ENTITY_TYPE_update() for node entities.
 */
function mars_product_node_update(EntityInterface $node) {
  if ($node->bundle() != 'product_variant') {
    return;
  }

  // If we're not dealing with the default revision of the variant,
  // do not make any change to the product.
  if (!$node->isDefaultRevision()) {
    return;
  }

  // Update product title and description when product variant
  // was saved with Family Master flag.
  $is_master_variant = $node->get('field_product_family_master')->value;
  if ($is_master_variant) {
    $product_helper = \Drupal::service('mars_product.product_helper');

    // Get master products by variant.
    $products = $product_helper->getProductsByVariant($node);

    if (!empty($products)) {
      foreach ($products as $product) {

        // Update product title.
        $product->setTitle($node->getTitle());

        // Update product description.
        $variant_description = $node->get('field_product_description')->value;
        $product->set('field_product_description', $variant_description);

        // Publishing the product automatically.
        $product->set('moderation_state', 'published');
        $product->save();
      }
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function mars_product_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  if ($form_id == 'node_product_form' || $form_id == 'node_product_edit_form') {
    $form['field_rating_and_reviews']['#states'] = [
      'visible' => [
        ':input[name="field_override_global_rating[value]"]' => ['checked' => TRUE],
      ],
    ];
  }
  if ($form_id == 'node_product_variant_form' || $form_id == 'node_product_variant_edit_form') {

    $wtb_config = \Drupal::config('mars_product.wtb.settings');
    $vendor = $wtb_config->get('commerce_vendor') ?? '';

    if ($vendor == PdpHeroBlock::VENDOR_MANUAL_LINK_SELECTION) {
      $form['field_product_wtb_button_name']['widget']['#required'] = TRUE;
      $form['field_product_wtb_button_name']['widget'][0]['#required'] = TRUE;
      $form['field_product_wtb_button_name']['widget'][0]['value']['#required'] = TRUE;
      $form['field_product_wtb_button_url']['widget']['#required'] = TRUE;
      $form['field_product_wtb_button_url']['widget'][0]['#required'] = TRUE;
      $form['field_product_wtb_button_url']['widget'][0]['value']['#required'] = TRUE;
    }
    else {
      unset($form['#fieldgroups']['group_wtb_manual_link']);
      $form['field_product_wtb_button_name']['#access'] = FALSE;
      $form['field_product_wtb_button_url']['#access'] = FALSE;
      $form['field_product_wtb_button_style']['#access'] = FALSE;
      $form['field_product_hide_wtb_link']['#access'] = FALSE;
      $form['field_product_wtb_new_tab']['#access'] = FALSE;
    }
  }
}

/**
 * Product card change color.
 */
function product_card_change_color(&$variables) {
  $color_key = \Drupal::config(MarsCardColorSettingsForm::SETTINGS)->get('select_background_color_product');
  card_change_color($variables, $color_key);
}

/**
 * Implements hook_js_alter().
 */
function mars_product_js_alter(&$javascript, AttachedAssetsInterface $assets) {
  $current_uri = \Drupal::request()->getRequestUri();
  foreach ($javascript as $key => $script) {
    if (strpos($key, '[commerce_connector_url]') !== FALSE) {
      $wtb_confg = \Drupal::config('mars_product.wtb.settings');
      $vendor = $wtb_confg->get('commerce_vendor');
      $commerce_vendor_settings = [];
      if (!empty($vendor)) {
        $commerce_vendor_settings = \Drupal::configFactory()->get('mars_product.wtb.' . $vendor . '.settings');
        $commerce_vendor_settings = !$commerce_vendor_settings->isNew() ? $commerce_vendor_settings->getRawData()['settings'] : [];
      }
      if (isset($vendor) && $vendor == PdpHeroBlock::VENDOR_COMMERCE_CONNECTOR) {
        $locale = \Drupal::languageManager()
          ->getCurrentLanguage()->getId();
        $commerce_connector_url = '//fi-v2.global.commerce-connector.com/cc.js';
        // Updating library JS path.
        $javascript[$key]['data'] = '\/';
        // Setting library attributes.
        $javascript[$key]['attributes'] = [
          'data-src' => $commerce_connector_url,
          'id' => 'cci-widget',
          'data-token' => !empty($commerce_vendor_settings['data_token']) ? $commerce_vendor_settings['data_token'] : NULL,
          'data-locale' => !empty($commerce_vendor_settings['data_locale']) ? $commerce_vendor_settings['data_locale'] : NULL,
          'data-displaylanguage' => !empty($commerce_vendor_settings['data_displaylanguage']) ? $commerce_vendor_settings['data_displaylanguage'] : $locale,
          'data-widgetid' => !empty($commerce_vendor_settings['widget_id']) ? $commerce_vendor_settings['widget_id'] : NULL,
          'data-subid' => !empty($commerce_vendor_settings['data_subid']) ? $commerce_vendor_settings['data_subid'] : NULL,
        ];
      }
    }
    if (strpos($key, '[bazaarvoice_placeholder]') !== FALSE) {
      $bazaarvoice_settings = \Drupal::config('mars_product.bazaarvoice.settings');
      if ($bazaarvoice_settings instanceof ImmutableConfig) {
        $staging_url = \Drupal::config(BazaarvoiceConfigForm::SETTINGS)->get('staging_script_url');
        $production_url = \Drupal::config(BazaarvoiceConfigForm::SETTINGS)->get('production_script_url');

        if (EnvironmentDetector::isProdEnv() && !empty($production_url)) {
          // Updating library JS path.
          $javascript[$key]['data'] = $production_url;
        }
        elseif (!empty($staging_url)) {
          // Updating library JS path.
          $javascript[$key]['data'] = $staging_url;
        }

        $javascript[$key]['attributes'] = [
          'data-src' => $javascript[$key]['data'],
          'type' => 'text/javascript',
          'id' => 'bazaar-voice-scripts',
        ];
        $javascript[$key]['data'] = ($current_uri == '/where-buy' || count(explode("/", $current_uri)) >= 1) ? $javascript[$key]['data'] : '\/';
      }
    }
    if (strpos($key, '[price_spider_url]') !== FALSE) {
      $price_spider_url = '//cdn.pricespider.com/1/lib/ps-widget.js';
      if ($current_uri == '/where-buy' || strpos($current_uri, '/products') !== FALSE) {
        $javascript[$key]['data'] = $price_spider_url;
      }
      else {
        $javascript[$key]['data'] = '\/';
      }
      $javascript[$key]['attributes'] = [
        'data-src' => $price_spider_url,
        'id' => 'ps-widget',
      ];
    }
    if (strpos($key, '[smart_commerce_url]') !== FALSE) {
      $smart_commerce_url = '//click2cart.co/assets/js/smartcart_min.js';
      if ($current_uri == '/where-buy' || count(explode("/", $current_uri)) >= 1) {
        $javascript[$key]['data'] = $smart_commerce_url;
      }
      else {
        $javascript[$key]['data'] = '\/';
      }
      $javascript[$key]['attributes'] = [
        'data-src' => $smart_commerce_url,
        'type' => 'text/javascript',
        'id' => 'smart-commerce-widget',
        'data-ot-ignore' => TRUE,
      ];
    }
  }
}
