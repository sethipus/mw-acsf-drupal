<?php

/**
 * @file
 * MARS Common module main file.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Element;

/**
 * Implements hook_theme().
 */
function mars_common_theme($existing, $type, $theme, $path) {
  return [
    'header_block' => [
      'variables' => [
        'logo'              => NULL,
        'primary_menu'      => NULL,
        'secondary_menu'    => NULL,
        'search_menu'       => NULL,
        'language_selector' => NULL,
        'search_block'      => NULL,
        'alert_banner'      => NULL,
      ],
      'template' => 'block--mars-common--header',
    ],
    'footer_block' => [
      'variables' => [
        'logo'            => NULL,
        'twix_border'     => NULL,
        'social_links'    => NULL,
        'top_footer_menu' => NULL,
        'legal_links'     => NULL,
        'marketing'       => NULL,
        'corporate_tout'  => NULL,
        'region_selector' => NULL,
      ],
      'template' => 'footer-block',
    ],
    'content_feature_module_block' => [
      'variables' => [
        'eyebrow' => NULL,
        'label' => NULL,
        'background' => NULL,
        'description' => NULL,
        'explore_cta' => NULL,
        'explore_cta_link' => NULL,
      ],
      'template' => 'content-feature-module-block',
    ],
    'social_feed_block' => [
      'variables' => [
        'title' => '',
        'items' => [],
      ],
    ],
    'parent_page_header_block' => [
      'variables' => [
        'eyebrow' => NULL,
        'label' => NULL,
        'background' => NULL,
        'description' => NULL,
      ],
      'template' => 'parent-page-header-block',
    ],
    'file_text_item_widget' => [
      'render element' => 'element',
    ],
    'carousel_item_formatter' => [
      'variables' => [
        'item_url' => NULL,
        'item_description' => NULL,
        'media_type' => NULL,
      ],
    ],
    'list_item_formatter' => [
      'variables' => [
        'item_url' => NULL,
        'item_description' => NULL,
      ],
    ],
  ];
}

/**
 * Prepares variables for carousel item widget templates.
 *
 * Default template: carousel-item-widget.html.twig.
 *
 * @param array $variables
 *   An associative array containing:
 *   - element: A render element representing the carousel item field widget.
 */
function mars_common_preprocess_file_text_item_widget(array &$variables) {
  $element = $variables['element'];

  $variables['attributes'] = [
    'class' => [
      'carousel-item-widget',
      'js-form-managed-file',
      'form-managed-file',
      'clearfix',
    ],
  ];

  $variables['data'] = [];
  foreach (Element::children($element) as $child) {
    $variables['data'][$child] = $element[$child];
  }

}

/**
 * Implements hook_preprocess_HOOK().
 */
function mars_common_preprocess_block__inline_block__media_carousel(array &$variables) {
  $field_carousel_title = $variables['content']['field_carousel_title'];
  $field_carousel_items = $variables['content']['field_carousel_items'];

  $media_items = [];
  foreach ($field_carousel_items as $item_key => $item_value) {
    if (is_numeric($item_key)) {
      $media_items[] = [
        'src' => $item_value['#item_url']->getUri(),
        'content' => $item_value['#item_description'],
        'video' => ($item_value['#media_type'] == 'video'),
        'image' => ($item_value['#media_type'] == 'image'),
        'alt' => NULL,
        'title' => NULL,
      ];
    }
  }

  $variables['title'] = $field_carousel_title['#items'][0]->value;
  $variables['items'] = $media_items;
}

/**
 * Implements hook_form_alter().
 */
function mars_common_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ($form_id === 'block_form') {
    $form['settings']['label_display']['#access'] = FALSE;
  }
}
