id: multibrand_node_product_multipack
label: Product multipack nodes (multibrand)
migration_group: multibrand
migration_tags:
  - Node
migration_dependencies:
  optional:
    - multibrand_term_product_category
    - multibrand_term_product_flavor
    - multibrand_term_product_format
    - multibrand_term_product_occasions
    - multibrand_node_product_variant
    - multibrand_node_product
    - multibrand_node_product_2
    - multibrand_node_product_3
    - multibrand_node_product_4
    - multibrand_node_product_5
    - multibrand_node_product_5
source:
  plugin: brand_drupal_salsify_url
  data_fetcher_plugin: http
  data_parser_plugin: json_filter
  filter:
    - Drupal\salsify_integration\Filter
    - isProductMultipackSuffixed
  item_selector: /
  track_changes: true
  constants:
    destination: 'public://migrate-images/products'
  fields:
    -
      name: source_category
      label: ' CMS: Category Computed'
      selector: 'field_product_category/0'
    -
      name: source_product_description
      label: 'CMS: Description'
      selector: 'field_product_description/0'
    -
      name: source_product_name
      label: ' CMS: Product Name'
      selector: 'field_product_name/0'
    -
      name: source_sku
      label: 'GTIN'
      selector: 'field_product_sku/0'
    -
      name: source_product_flavor
      label: 'Brandbank Variant'
      selector: 'field_product_flavor/0'
    -
      name: source_keywords
      label: 'CMS: Keywords'
      selector: 'field_meta_keywords/0'
    -
      name: source_meta_description
      label: 'CMS: Meta Description'
      selector: 'field_meta_description/0'
    -
      name: source_meta_title
      label: 'CMS: Meta Title'
      selector: 'field_meta_title/0'
    -
      name: source_product_format
      label: 'RSU LTD Pack Type'
      selector: 'field_product_format/0'
    -
      name: source_product_occasions
      label: 'Product Occasions'
      selector: 'field_product_occasions/0'
    -
      name: source_product_market
      label: 'Product Market'
      selector: 'field_product_market/0'
    -
      name: source_variety
      label: 'Product Pack items'
      selector: 'field_variety'

  ids:
    source_sku:
      type: string
process:
  title:
    plugin: skip_on_empty
    method: row
    source: source_product_name

  _field_product_variants:
    -
      plugin: migration_lookup_ids
      migration:
        - multibrand_node_product_variant
      source_ids:
        multibrand_node_product_variant:
          source_sku: source_sku
    -
      plugin: ensure_is_array
    -
      plugin: value_to_array
      key: target_id

  field_product_variants:
    plugin: sub_process
    source: '@_field_product_variants'
    process:
      target_id:
        plugin: get
        source: target_id

  field_product_pack_items:
    -
      plugin: sku_to_suffixed_products_array
      source: source_sku
      multipack_suffixes:
        - 2
        - 3
        - 4
        - 5
        - 6
#    -
#      plugin: explode
#      delimiter: ', '
    -
      plugin: value_to_array
      key: sku
    -
      plugin: sub_process
      process:
        target_id:
          -
            plugin: migration_lookup_ids
            migration:
              - multibrand_node_product_2
              - multibrand_node_product_3
              - multibrand_node_product_4
              - multibrand_node_product_5
              - multibrand_node_product_6
            source_ids:
              multibrand_node_product_2:
                source_sku: sku
              multibrand_node_product_3:
                source_sku: sku
              multibrand_node_product_4:
                source_sku: sku
              multibrand_node_product_5:
                source_sku: sku
              multibrand_node_product_6:
                source_sku: sku
#    -
#      plugin: multipack_product_postprocess
#      hide_product: true
#      moderation_state: 'published'
  field_product_category/target_id:
    plugin: migration_lookup
    migration:
     - multibrand_term_product_category
    source: source_category
    no_stub: true
  field_product_description/value: source_product_description
  field_product_name: source_product_name
  field_product_sku:
    plugin: skip_on_empty
    method: row
    source: source_sku
  field_product_market/value: source_product_market
  field_product_flavor/target_id:
    plugin: migration_lookup
    migration:
      - multibrand_term_product_flavor
    source: source_product_flavor
    no_stub: true
  metatags/0/title: source_meta_title
  metatags/0/description: source_meta_description
  metatags/0/keywords: source_keywords
  field_meta_tags:
    - plugin: callback
      callable: serialize
      source: '@metatags'
  field_meta_keywords/value: source_keywords
  field_product_format/target_id:
    plugin: migration_lookup
    migration:
     - multibrand_term_product_format
    source: source_product_format
    no_stub: true
  field_product_occasions/target_id:
    plugin: migration_lookup
    migration:
     - multibrand_term_product_occasions
    source: source_product_occasions
    no_stub: true
  type:
    plugin: default_value
    default_value: product_multipack
  uid:
    plugin: default_value
    default_value: 1
  status:
    plugin: default_value
    default_value: 1
  langcode:
    plugin: salsify_i18n_process_language
    source: language
    default_value: 'und'
  moderation_state:
    plugin: static_map
    source: '@status'
    default_value: draft
    map:
      '0': draft
      '1': published
destination:
  plugin: entity:node
