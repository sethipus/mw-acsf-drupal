<?php

/**
 * @file
 * MARS Search module main file.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\mars_search\Controller\AutocompleteController;
use Drupal\views\ViewExecutable;
use Drupal\search_api\IndexInterface;

/**
 * Implements hook_theme().
 */
function mars_search_theme($existing, $type, $theme, $path) {
  return [
    'mars_search_suggestions' => [
      'variables' => [
        'suggestions' => [],
        'show_all' => NULL,
        'empty_text' => NULL,
        'empty_text_description' => NULL,
      ],
    ],
    'mars_search_header' => [
      'variables' => [
        'search_header_heading' => NULL,
        'brand_shape' => NULL,
        'input_form' => NULL,
        'search_results' => NULL,
      ],
      'template' => 'mars-search-header',
    ],
    'mars_search_no_results' => [
      'variables' => [
        'no_results_links' => NULL,
        'no_results_text' => NULL,
        'no_results_heading' => NULL,
      ],
      'template' => 'mars-search-no-results',
    ],
  ];
}

/**
 * Changes an exposed "type" filter from a multi-select to checkboxes.
 */
function mars_search_form_views_exposed_form_alter(&$form, FormStateInterface $form_state) {
  // Retrieve the view object and the query plugin.
  $storage = $form_state->getStorage();
  if (!isset($storage['view'])) {
    return;
  }
  $view = $storage['view'];
  if (!($view instanceof ViewExecutable)) {
    return;
  }

  $allowed_views_ids = \Drupal::config('mars_search.autocomplete')->get('views');
  if (!$allowed_views_ids || !in_array($view->id(), $allowed_views_ids)) {
    return;
  }
  // We need these values for the query.
  $form[AutocompleteController::MARS_SEARCH_EXPOSED_FIELD_NAME]['#attributes']['data-view_id'] = $view->id();
  $form[AutocompleteController::MARS_SEARCH_EXPOSED_FIELD_NAME]['#attributes']['data-display_id'] = $view->current_display;
  // To indicate this textfield supports autocomplete.
  $form[AutocompleteController::MARS_SEARCH_EXPOSED_FIELD_NAME]['#attributes']['class'][] = 'mars-autocomplete-field';
  $form[AutocompleteController::MARS_SEARCH_EXPOSED_FIELD_NAME]['#attributes']['autocomplete'] = 'off';
  // Attaching javasript for autocomplete.
  $form['#attached']['library'][] = 'mars_search/autocomplete';
}

/**
 * Implements hook_search_api_index_items_alter().
 */
function mars_search_search_api_index_items_alter(IndexInterface $index, array &$items) {
  /** @var Drupal\search_api\Item\Item $item */
  foreach ($items as $item) {
    /** @var Drupal\Core\Entity\Plugin\DataType\EntityAdapter $object */
    $object = $item->getOriginalObject();

    $type = $object->get('type')->target_id;
    if ($type == 'product_multipack') {
      $object->set('type', 'product');
    }
    $item->setOriginalObject($object);
  }
}
