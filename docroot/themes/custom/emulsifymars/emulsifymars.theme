<?php

/**
 * @file
 * Functions to support theming.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Markup;
use Drupal\Core\Url;
use Drupal\file\Entity\File;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function emulsifymars_form_system_theme_settings_alter(&$form, FormStateInterface $form_state, $form_id = NULL) {
  \Drupal::service('mars_common.theme_configurator_service')->getThemeConfiguratorForm($form, $form_state);

  if (isset($form['logo']['settings']['logo_upload']['#upload_validators']['file_validate_is_image'])) {
    unset($form['logo']['settings']['logo_upload']['#upload_validators']['file_validate_is_image']);
  }
  $form['logo']['settings']['logo_upload']['#upload_validators']['file_validate_extensions'] = [
    'png gif jpg jpeg apng svg',
  ];
}

/**
 * Implements hook_preprocess_html().
 */
function emulsifymars_preprocess_html(&$variables) {
  $theme_settings = Drupal::config('emulsifymars.settings')->get();
  $style_tag = sprintf("@font-face {font-family: 'DrupalHeadlineCampaignFont'; src: url('%s') format('opentype');}", $theme_settings['headline_font_path']);
  $style_tag .= sprintf("@font-face {font-family: 'DrupalPrimaryTypefaceFont'; src: url('%s') format('opentype');}", $theme_settings['primary_font_path']);
  $style_tag .= sprintf("@font-face {font-family: 'DrupalSecondaryTypefaceFont'; src: url('%s') format('opentype');}", $theme_settings['secondary_font_path']);
  $style_tag .= sprintf(":root [data-theme='drupal'] {%s}", _emulsifymars_preprocess_css_properties($theme_settings));
  $variables['page']['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'style',
      '#value' => $style_tag,
      '#attributes' => [
        'type' => 'text/css',
      ],
    ],
    'custom-css-properties',
  ];

  // CSS Variables Polyfill for IE11 package ie11-custom-properties.
  $url = "https://cdn.jsdelivr.net/gh/nuxodin/ie11CustomProperties@4.1.0/ie11CustomProperties.min.js";
  $script = "window.MSInputMethodContext && document.documentMode && document.write('<script src=\"$url\"><\/script>');";
  $variables['page']['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#value' => Markup::create($script),
      '#attributes' => [
        'type' => 'text/javascript',
      ],
    ],
    'custom-css',
  ];
}

/**
 * Process css custom properties.
 *
 * @param array $settings
 *   Theme settings array.
 *
 * @return string
 *   Parsed custom properties string.
 */
function _emulsifymars_preprocess_css_properties(array $settings): string {
  $properties = '';
  $properties .= sprintf(" --c-primary: #%s;", $settings['color_a']);
  $properties .= sprintf(" --c-secondary: #%s;", $settings['color_b']);
  $properties .= sprintf(" --c-subcolor-1: #%s;", $settings['color_c']);
  $properties .= sprintf(" --c-subcolor-2: #%s;", $settings['color_d']);
  $properties .= sprintf(" --c-subcolor-3: #%s;", $settings['color_e']);
  $properties .= sprintf(" --c-subcolor-4: #%s;", $settings['color_f']);
  $properties .= sprintf(" --c-primary-rgb: %s;", hex2_rgb($settings['color_a'], TRUE));
  $properties .= sprintf(" --c-secondary-rgb: %s;", hex2_rgb($settings['color_b'], TRUE));
  $properties .= sprintf(" --c-subcolor-1-rgb: %s;", hex2_rgb($settings['color_c'], TRUE));
  $properties .= sprintf(" --c-subcolor-2-rgb: %s;", hex2_rgb($settings['color_d'], TRUE));
  $properties .= sprintf(" --c-subcolor-3-rgb: %s;", hex2_rgb($settings['color_e'], TRUE));
  $properties .= sprintf(" --c-subcolor-4-rgb: %s;", hex2_rgb($settings['color_f'], TRUE));
  $properties .= sprintf(" --c-top-nav: #%s;", $settings['top_nav']);
  $properties .= sprintf(" --c-top-nav-gradient: #%s;", $settings['top_nav_gradient']);
  $properties .= sprintf(" --c-bottom-nav: #%s;", $settings['bottom_nav']);
  $properties .= sprintf(" --c-card-background: #%s;", $settings['card_background']);

  $properties .= sprintf(" --v-heading-font: %s;", 'DrupalHeadlineCampaignFont');
  $properties .= sprintf(" --v-primary-font: %s;", 'DrupalPrimaryTypefaceFont');
  $properties .= sprintf(" --v-secondary-font: %s;", 'DrupalSecondaryTypefaceFont');

  if (theme_get_setting('button_style') == 0) {
    $properties .= sprintf(" --v-button-border-radius: %s;", '30px');
    $properties .= sprintf(" --v-card-border-radius: %s;", '20px');
  }
  else {
    $properties .= sprintf(" --v-button-border-radius: %s;", '0');
    $properties .= sprintf(" --v-card-border-radius: %s;", '0');
  }

  _emulsifymars_load_images_from_theme($properties);

  return $properties;
}

/**
 * Convert a hexa decimal color code to its RGB equivalent.
 *
 * @param string $hexStr
 *   Hexadecimal color value.
 * @param bool $returnAsString
 *   If set true, returns the value separated by the separator character.
 *   Otherwise returns associative array.
 * @param string $seperator
 *   To separate RGB values. Applicable only if second parameter is true.
 */
function hex2_rgb($hexStr, $returnAsString = FALSE, $seperator = ',') {
  $hexStr = preg_replace("/[^0-9A-Fa-f]/", '', $hexStr);
  $rgbArray = [];
  if (strlen($hexStr) == 6) {
    $colorVal = hexdec($hexStr);
    $rgbArray['red'] = 0xFF & ($colorVal >> 0x10);
    $rgbArray['green'] = 0xFF & ($colorVal >> 0x8);
    $rgbArray['blue'] = 0xFF & $colorVal;
  }
  elseif (strlen($hexStr) == 3) {
    $rgbArray['red'] = hexdec(str_repeat(substr($hexStr, 0, 1), 2));
    $rgbArray['green'] = hexdec(str_repeat(substr($hexStr, 1, 1), 2));
    $rgbArray['blue'] = hexdec(str_repeat(substr($hexStr, 2, 1), 2));
  }
  else {
    return FALSE;
  }
  return $returnAsString ? implode($seperator, $rgbArray) : $rgbArray;
}

/**
 * Helper function to preload images as background with theme configurator.
 */
function _emulsifymars_load_images_from_theme(string &$properties) {
  /** @var \Drupal\mars_common\ThemeConfiguratorParser $themeParser */
  $themeParser = Drupal::service('mars_common.theme_configurator_parser');
  $assets = [
    'graphic_divider' => $themeParser->getGraphicDivider(),
    'brand_shape' => $themeParser->getBrandShape(),
  ];

  /** @var \Drupal\mars_common\SVG\SVG|null $asset */
  foreach ($assets as $asset_name => $asset) {
    if ($asset) {
      $css_var_name = str_replace('_', '-', $asset_name);
      $css_var_value = 'url("data:image/svg+xml;base64,' . $asset->toBase64() . '")';
      $properties .= sprintf(" --v-%s: %s;", $css_var_name, $css_var_value);
    }
  }
}

/**
 * Implements hook_preprocess_social_icons().
 */
function emulsifymars_preprocess_social_icons(&$variables) {
  $social_menu_items = &$variables['social_menu_items'];
  $theme_settings = Drupal::config('emulsifymars.settings')->get();
  foreach ($theme_settings['social'] as $key => $social_settings) {
    $social_menu_items[$key]['title'] = $social_settings['name'];
    $social_menu_items[$key]['url'] = $social_settings['link'];
    if (!empty($social_settings['icon'])) {
      $fid = reset($social_settings['icon']);
      $file = File::load($fid);
    }
    $social_menu_items[$key]['icon'] = !empty($file) ? $file->createFileUrl() : '';
  }
}

/**
 * Implements hook_theme().
 */
function emulsifymars_theme() {
  return [
    'social_icons' => [
      'template'   => 'misc/social-menu',
      'variables'  => [
        'social_menu_items' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_preprocess_views_view_unformatted().
 */
function emulsifymars_preprocess_views_view_unformatted(&$variables) {
  /** @var \Drupal\mars_common\MediaHelper $media_helper */
  $media_helper = \Drupal::service('mars_common.media_helper');
  $view = $variables['view'];
  $id = $view->storage->id();
  $items = [];

  if ($id == 'related_recipes') {
    foreach ($view->result as $result) {
      /** @var \Drupal\Core\Entity\ContentEntityInterface $entity */
      $entity = $result->_entity;
      $url = Url::fromRoute('entity.node.canonical', ['node' => $entity->id()]);
      $url = $url->toString();

      $body_raw = $entity->get('field_recipe_description')->first()->getValue();
      $description = !empty($body_raw['value']) ? $body_raw['value'] : '';

      $media_id = $media_helper->getEntityMainMediaId($entity);
      $media_params = $media_helper->getMediaParametersById($media_id);

      $image_src = NULL;
      $image_alt = NULL;
      if (!($media_params['error'] ?? FALSE) && ($media_params['src'] ?? FALSE)) {
        $image_src = $media_params['src'];
        $image_alt = $media_params['alt'];
      }

      $items[] = [
        'card__image__src' => $image_src,
        'card__image__alt' => $image_alt,
        'card__heading' => $entity->getTitle(),
        'card__link__url' => $url,
        'card__link__text' => t('See details'),
        'card__body' => $description,
      ];
    }
  }
  /** @var \Drupal\mars_common\ThemeConfiguratorParser $themeParser */
  $themeParser = \Drupal::service('mars_common.theme_configurator_parser');
  $variables['divider'] = $themeParser->getGraphicDivider();
  $variables['brand_borders'] = $themeParser->getBrandBorder2('recipe-hero-border');

  $variables['theme_styles'] = 'drupal';
  $variables['grid_type'] = 'card';
  $variables['item_type'] = 'card';
  $variables['items'] = $items;
}
